name: Launch VS Code Dev Server

on:
  # æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:

jobs:
  dev-server:
    # Ubuntuã®æœ€æ–°ç‰ˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨
    runs-on: ubuntu-latest
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å¿…è¦ãªæ¨©é™ã®ã¿ã«çµã‚‹
    permissions:
      contents: read

    # ã‚¸ãƒ§ãƒ–ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’60åˆ†ã«è¨­å®šï¼ˆä»»æ„ï¼‰
    timeout-minutes: 60

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      - name: Generate Password
        run: |
          # opensslã‚’ä½¿ã£ã¦32æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
          PASSWORD=$(openssl rand -base64 32)
          # ç”Ÿæˆã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ­ã‚°ã«ä¸€åº¦ã ã‘è¡¨ç¤º
          echo "ğŸ” The password for this session is: ${PASSWORD}"
          # ã“ã‚Œä»¥é™ã®ãƒ­ã‚°ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãƒã‚¹ã‚¯ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®š
          echo "::add-mask::${PASSWORD}"
          # å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "PASSWORD=${PASSWORD}" >> $GITHUB_ENV

      # 3. code-serverã¨Serveoã‚’èµ·å‹•
      - name: Start code-server and Serveo
        run: |
          # code-serverã‚’èµ·å‹• (ä¸Šè¨˜ã¨åŒã˜)
          docker run -d --name code-server -p 127.0.0.1:8080:8080 \
            -e "PASSWORD=${PASSWORD}" \
            -v "${{ github.workspace }}:/home/coder/project" \
            codercom/code-server:latest

          # Serveoã‚’ä½¿ã£ã¦ãƒˆãƒ³ãƒãƒ«ã‚’èµ·å‹•
          # SSHã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã€ãƒ­ã‚°ã‚’serveo.logã«å‡ºåŠ›
          ssh -R 80:localhost:8080 serveo.net > serveo.log 2>&1 &
          TUNNEL_PID=$!

          echo "â³ Waiting for tunnel URL..."
          sleep 10

          # ãƒ­ã‚°ã‹ã‚‰å…¬é–‹URLã‚’æŠ½å‡º
          URL=$(grep -m 1 'serveo.net' serveo.log | awk '{print $6}')
          
          if [ -z "$URL" ]; then
            echo "âŒ Failed to retrieve tunnel URL. Check the logs."
            cat serveo.log
            exit 1
          fi

          echo "ğŸš€ Access your VS Code session at: ${URL}"
          echo "URL=${URL}" >> $GITHUB_ENV

      # 4. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒçµ‚äº†ã—ãªã„ã‚ˆã†ã«å¾…æ©Ÿ
      - name: Keep the server alive
        run: |
          echo "âœ… VS Code server is running."
          echo "ğŸ›‘ To stop the server, cancel this workflow run."
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ‰‹å‹•ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã¾ã§å®Ÿè¡Œã—ç¶šã‘ã‚‹
          while true; do
            sleep 30
            # ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã¨ã—ã¦å®šæœŸçš„ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
            echo "ğŸ”„ Server is still running at $(date)"
          done
