name: Launch VS Code Dev Server (Cloudflare Tunnel)

on:
  workflow_dispatch:

jobs:
  dev-server:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Password
        run: |
          PASSWORD=$(openssl rand -base64 32)
          echo "ðŸ” The password for this session is: ${PASSWORD}"
          echo "::add-mask::${PASSWORD}"
          echo "PASSWORD=${PASSWORD}" >> $GITHUB_ENV

      - name: Start code-server and Cloudflare Tunnel
        run: |
          # code-serverã‚’èµ·å‹•
          docker run -d --name code-server -p 127.0.0.1:8080:8080 \
            -e "PASSWORD=${PASSWORD}" \
            -v "${{ github.workspace }}:/home/coder/project" \
            codercom/code-server:latest

          # cloudflaredã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          
          # cloudflaredã‚’ä½¿ã£ã¦ãƒˆãƒ³ãƒãƒ«ã‚’èµ·å‹•
          # --logfile ã‚’ä½¿ã†ã¨ãƒ­ã‚°ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã•ã‚Œã€å®‰å®šã—ã‚„ã™ã„
          cloudflared tunnel --url localhost:8080 --logfile tunnel.log &
          TUNNEL_PID=$!

          echo "â³ Waiting for tunnel URL..."
          sleep 15 # å°‘ã—å¾…ã¡æ™‚é–“ã‚’é•·ãã™ã‚‹

          # ãƒ­ã‚°ã‹ã‚‰URLã‚’æ­£è¦è¡¨ç¾ã§æŠ½å‡ºã™ã‚‹æ–¹æ³•ï¼ˆã‚ˆã‚Šå …ç‰¢ï¼‰
          URL=$(grep -oE 'https://[a-zA-Z0-9.-]+\.trycloudflare\.com' tunnel.log | head -n 1)
          
          if [ -z "$URL" ]; then
            echo "âŒ Failed to retrieve tunnel URL. Check the logs."
            cat tunnel.log
            exit 1
          fi

          echo "ðŸš€ Access your VS Code session at: ${URL}"
          echo "URL=${URL}" >> $GITHUB_ENV

      - name: Keep the server alive
        run: |
          echo "âœ… VS Code server is running."
          echo "ðŸ›‘ To stop the server, cancel this workflow run."
          while true; do
            sleep 30
            echo "ðŸ”„ Server is still running at $(date)"
          done
